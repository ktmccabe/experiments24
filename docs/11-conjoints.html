<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Experiments 2024 - 11&nbsp; Conjoints</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./10-Mediation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-conjoints.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Conjoints</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Experiments 2024</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Notes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-Experimentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Why Experiment?</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-CausalEffects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Causal Effects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-ExperimentalDesign.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Experimental Design</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Uncertainty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Uncertainty</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Visualization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ethics and Sampling Considerations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-FieldExperiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Field Experiments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-QuasiNaturalExperiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Quasi and Natural Experiments</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-LabExperiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Lab Experiments and Behavioral Games</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Mediation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-conjoints.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Conjoints</span></span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Section Contents</h2>
   
  <ul>
  <li><a href="#conjoint-overview" id="toc-conjoint-overview" class="nav-link active" data-scroll-target="#conjoint-overview"><span class="header-section-number">11.1</span> Conjoint Overview</a></li>
  <li><a href="#amce-effects" id="toc-amce-effects" class="nav-link" data-scroll-target="#amce-effects"><span class="header-section-number">11.2</span> AMCE effects</a></li>
  <li><a href="#amce-estimation" id="toc-amce-estimation" class="nav-link" data-scroll-target="#amce-estimation"><span class="header-section-number">11.3</span> AMCE estimation</a></li>
  <li><a href="#conjoint-application-in-r" id="toc-conjoint-application-in-r" class="nav-link" data-scroll-target="#conjoint-application-in-r"><span class="header-section-number">11.4</span> Conjoint Application in R</a>
  <ul>
  <li><a href="#a-wrinkle--restricted-combinations" id="toc-a-wrinkle--restricted-combinations" class="nav-link" data-scroll-target="#a-wrinkle--restricted-combinations"><span class="header-section-number">11.4.1</span> A wrinkle- restricted combinations</a></li>
  <li><a href="#visualizing-the-amce-with-a-package" id="toc-visualizing-the-amce-with-a-package" class="nav-link" data-scroll-target="#visualizing-the-amce-with-a-package"><span class="header-section-number">11.4.2</span> Visualizing the AMCE with a package</a></li>
  <li><a href="#subgroup-analysis" id="toc-subgroup-analysis" class="nav-link" data-scroll-target="#subgroup-analysis"><span class="header-section-number">11.4.3</span> Subgroup analysis</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="conjoints" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Conjoints</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In this section, we will briefly go over conjoint designs. You can see the following resources:</p>
<ul>
<li>Application: Hainmueller, Jens and Daniel J. Hopkins. <a href="https://onlinelibrary.wiley.com/doi/epdf/10.1111/ajps.12138">“The Hidden American Immigration Consensus: A Conjoint Analysis of Attitudes toward Immigrants.”</a> American Journal of Political Science 59(3): 529-48.</li>
<li>Methods: Hainmueller, J., Hopkins, D., &amp; Yamamoto, T. (2014). <a href="https://www.cambridge.org/core/journals/political-analysis/article/causal-inference-in-conjoint-analysis-understanding-multidimensional-choices-via-stated-preference-experiments/414DA03BAA2ACE060FFE005F53EFF8C8">“Causal Inference in Conjoint Analysis: Understanding Multidimensional Choices via Stated Preference Experiments.”</a> Political Analysis, 22(1), 1-30. doi:10.1093/pan/mpt024</li>
<li>Caution in presentation: Leeper, T., Hobolt, S., &amp; Tilley, J. (2020). <a href="https://www.cambridge.org/core/journals/political-analysis/article/abs/measuring-subgroup-preferences-in-conjoint-experiments/4F2C21AC02753F1FFF2F5EA0F943C1B2">“Measuring Subgroup Preferences in Conjoint Experiments.”</a> Political Analysis, 28(2), 207-221. doi:10.1017/pan.2019.30</li>
<li>Caution in estimation of interactions: Naoki Egami &amp; Kosuke Imai (2019) <a href="https://www.tandfonline.com/doi/citedby/10.1080/01621459.2018.1476246">Causal Interaction in Factorial Experiments: Application to Conjoint Analysis</a>, Journal of the American Statistical Association, 114:526, 529-540, DOI: 10.1080/01621459.2018.1476246</li>
<li>Caution in population used: De la Cuesta, B., Egami, N., &amp; Imai, K. (2022). <a href="https://www.cambridge.org/core/journals/political-analysis/article/abs/improving-the-external-validity-of-conjoint-analysis-the-essential-role-of-profile-distribution/B911EF14513292A24ECB4AC4BAA3FA6B">Improving the External Validity of Conjoint Analysis: The Essential Role of Profile Distribution</a>. Political Analysis, 30(1), 19-45. doi:10.1017/pan.2020.40</li>
<li>Caution in interpretation of the effects of conjoints: Abramson, Scott F., Korhan Koçak, and Asya Magazinnik. <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/ajps.12714">“What do we learn about voter preferences from conjoint experiments?.”</a> American Journal of Political Science 66.4 (2022): 1008-1020.</li>
<li>Programming a conjoint in qualtrics: Strezhnev, Anton. <a href="https://github.com/astrezhnev/conjointsdt">Conjoint Survey Design Tool</a></li>
</ul>
<section id="conjoint-overview" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="conjoint-overview"><span class="header-section-number">11.1</span> Conjoint Overview</h2>
<p>Conjoint designs are a version of factorial experiments. Conjoints have been around for several decades in marketing and over the past 10 years, have picked up more frequently in their use in political science. Conjoints offer a way to understand multidimensional preferences.</p>
<ul>
<li>It allows a researcher to vary, simultaneously, several different dimensions or “attributes” about a concept, such as a candidate, a job applicant, a political policy proposal, etc.</li>
<li>This potentially offers an advantage over a standard vignette design where about only one dimension is varied across conditions.</li>
</ul>
<p>The most common form of a conjoint used in political science is a “choice-based” or “forced-choice” conjoint design.</p>
<p>Below is an example from Hainmueller and Hopkins (2014).</p>
<p><img src="images/conjointdes.png" class="img-fluid" style="width:90.0%"></p>
<p>In this study, survey respondents are asked to evaluate which of two immigrants should be given priority to come to the United States to live.</p>
<ul>
<li>Note that each respondent is “forced to choose” between a pair of profiles.
<ul>
<li>The design does not have to be set up this way. You could provide 3-4 profiles (e.g., in a multiparty system maybe you have several candidate profiles) or just 1 profile. But 2 is probably the most common for designs described as a conjoint.</li>
</ul></li>
<li>Each immigrant profile as a set of “attributes” or sometimes called “features” such as their Language Skills and Gender.
<ul>
<li>Each of these attributes has a set of possible Levels (e.g., Female, Male).</li>
<li>Generally, for every profile a respondent sees, within and across respondents, the Levels of each attribute are randomly assigned.</li>
<li>Sometimes the order of the attributes are also randomly ordered, while other times, a researcher may have a theoretical reason for fixing an attribute in a particular order.</li>
</ul></li>
<li>Note that the tabular design is very common in conjoints, as it makes it easier on the reader to compare across options. However, this is not required. You could present pairs of vignette paragraphs with randomly perturbed text, randomly varied bulleted lists, etc. This article from Hainmueller et al.&nbsp;(2015) compares a few <a href="https://www.pnas.org/doi/10.1073/pnas.1416587112">designs</a>.</li>
<li>Often, in addition or instead of forcing a choice between the profiles, respondents are asked to rate each profile in response to additional questions.</li>
</ul>
</section>
<section id="amce-effects" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="amce-effects"><span class="header-section-number">11.2</span> AMCE effects</h2>
<p>A common quantity of interest in political science applications of conjoint designs is the “average marginal component effect” or AMCE. This is very similar to the concept of an average treatment effect in a standard design. However, its interpretation takes into account the design feature that there are several components varying simultaneously.</p>
<p>The AMCE in the example estimates the difference in the probability that an immigrant was chosen when “comparing two different attribute values—for example, an immigrant with”fluent English” versus an immigrant with “broken English” - where the average is taken over all possible combinations of the other immigrant attributes” (Hainmueller and Hopkins 2014, 537) and across respondents in the sample.</p>
<ul>
<li>This acknowledges the possibility that if the design used a different set of attributes or the set of possible attribute combinations was designed differently, the AMCE might be different.</li>
</ul>
<p>A common way to present AMCE results is in the figure below:</p>
<p><img src="images/amcepres.png" class="img-fluid" style="width:80.0%"></p>
<p>Each estimate represents the average difference in probability an immigrant was chosen between a particular value of an attribute and the value of the attribute that was set as the reference category during the estimation.</p>
</section>
<section id="amce-estimation" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="amce-estimation"><span class="header-section-number">11.3</span> AMCE estimation</h2>
<p>A common way to analyze conjoint designs in political science is to follow the Hainmueller, Hopkins, Yamamoto (2014) <a href="https://www.cambridge.org/core/journals/political-analysis/article/causal-inference-in-conjoint-analysis-understanding-multidimensional-choices-via-stated-preference-experiments/414DA03BAA2ACE060FFE005F53EFF8C8">recommendations</a> and use linear regression with clustered standard errors. Once you have organized your data in the right way, this ends up being very similar to the analysis of standard experimental designs.</p>
<p>Let’s take a toy example.</p>
<p>Imagine that we had a sample of</p>
<ul>
<li>3 respondents who each completed 2 tasks where they evaluated 2 profiles.
<ul>
<li>This gives us 3 <span class="math inline">\(\times\)</span> 2 <span class="math inline">\(\times\)</span> 2 profile evaluations</li>
</ul></li>
<li>We want to organize our data so that each row represents a respondent-profile evaluation.
<ul>
<li>This means each respondent is represented 4 times in the data, 1 for each profile they evaluated. We have 12 observations overall.</li>
</ul></li>
<li>Let’s suppose each profile had three attributes- Gender, Country, and Language
<ul>
<li>These will be the columns associated with each profile evaluation</li>
</ul></li>
<li>We will also have a column for the outcome– whether a given profile was chosen – 1 if yes, 0 if no.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"conjointtoy.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>conjointtoy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Respondent Task Chosen Gender Country       Language
1           1    1      1 Female   China Fluent English
2           1    1      0   Male   China Fluent English
3           1    2      0 Female  Mexico     No English
4           1    2      1   Male   China     No English
5           2    1      0 Female   China Fluent English
6           2    1      1   Male   Sudan Fluent English
7           2    2      0 Female  Mexico Broken English
8           2    2      1 Female  Mexico Broken English
9           3    1      1   Male   China     No English
10          3    1      0 Female   Sudan Broken English
11          3    2      1   Male  Mexico Broken English
12          3    2      0 Female   China Fluent English</code></pre>
</div>
</div>
<p>So, in the first row, in task 1, respondent 1 evaluated a profile of a female immigrant from China who speaks fluent English. Based on the Chosen column, this profile was chosen for admission.</p>
<p>In the sixth row, respondent 2 in task 1 evaluated a profile of a male immigrant from Sudan who spoke fluent English. This profile was chosen for priority admission.</p>
<p>In estimating the AMCE, we want to know how the probability an immigrant was chosen varies as the attribute values vary.</p>
<ul>
<li>Let’s calculate the AMCE of going from Fluent English vs.&nbsp;No English in our toy (read: randomly generated) dataset.
<ul>
<li>We simply estimate the proportion of times an immigrant with Fluent English was chosen vs.&nbsp;the proportion of times an immigrant with No English was chosen. This does not necessarily equate to the proportion of people who prefer Fluent to No English immigrants, however, see the interpretations to follow.</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>prob.fluent <span class="ot">&lt;-</span> <span class="fu">mean</span>(conjointtoy<span class="sc">$</span>Chosen[conjointtoy<span class="sc">$</span>Language <span class="sc">==</span> <span class="st">"Fluent English"</span>])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>prob.no <span class="ot">&lt;-</span> <span class="fu">mean</span>(conjointtoy<span class="sc">$</span>Chosen[conjointtoy<span class="sc">$</span>Language <span class="sc">==</span> <span class="st">"No English"</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>prob.fluent <span class="sc">-</span> prob.no</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2666667</code></pre>
</div>
</div>
<p>This is equivalent to running a regression. Note that because respondents are represented multiple times in our data, we are going to use clustered standard errors.</p>
<p>We first make sure that “No English” is the reference category.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>conjointtoy<span class="sc">$</span>Language <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(conjointtoy<span class="sc">$</span>Language)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>conjointtoy<span class="sc">$</span>Language <span class="ot">&lt;-</span> <span class="fu">relevel</span>(conjointtoy<span class="sc">$</span>Language, <span class="at">ref=</span><span class="st">"No English"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Chosen <span class="sc">~</span> Language, <span class="at">data =</span> conjointtoy,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">se_type=</span><span class="st">"stata"</span>, <span class="at">clusters=</span>Respondent)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm_robust(formula = Chosen ~ Language, data = conjointtoy, clusters = Respondent, 
    se_type = "stata")

Standard error type:  stata 

Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper
(Intercept)              0.6667     0.2128  3.1334  0.08853  -0.2488   1.5821
LanguageBroken English  -0.1667     0.2128 -0.7833  0.51546  -1.0821   0.7488
LanguageFluent English  -0.2667     0.3343 -0.7977  0.50871  -1.7050   1.1717
                       DF
(Intercept)             2
LanguageBroken English  2
LanguageFluent English  2

Multiple R-squared:  0.04444 ,  Adjusted R-squared:  -0.1679 
F-statistic: 0.3182 on 2 and 2 DF,  p-value: 0.7586</code></pre>
</div>
</div>
<p>Note that we get the same estimate from each process. We estimate a -.27 difference in the likelihood an immigrant was given priority when counterfactually varying the immigrant’s language skills from “fluent English” to “No English”, averaging across respondents and the distribution of combinations of the other immigrant attributes.</p>
<p>The counterfactual we imagine, for example, is taking the potential outcome of first row profile: a profile of a female immigrant from China who speaks fluent English, and counterfactually imagining the potential outcome of that same profile of a female immigrant from China who speaks <strong><em>No English</em></strong>, both against a randomly generated profile. Then, we imagine another possible combination, for example, a profile of a female immigrant from Mexico who speaks fluent English vs.&nbsp;imagining the potential outcome of the profile of a female immigrant from Mexico who speaks <strong><em>No English</em></strong>, and we continue so on and so forth, imagining the average difference in potential outcomes that arises across all possible combinations of immigrant attributes from the profile being evaluated and the “opponent.”</p>
<p>That is, in paired-choice designs, we imagine that all attribute combinations of their opponent profiles are also varying. Here, AMCE compares the probability of an immigrant profile with fluent English chosen against another randomly generated profile (with fluent English or another Language skills level) to the probability of an immigrant profile with no English skills being chosen for priority against a similarly randomly generated immigrant profile.The AMCE asks “how much better or worse a randomly selected [immigrant profile] would fare” in this competition if Language skills vary from fluent to no English.</p>
<p>See <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3588941">Bansak et al.&nbsp;2022</a> for a detailed discussion of these AMCE interpretations. In general terms, for a paired-choice design, they recommend the interpretation:</p>
<ul>
<li>“The AMCE can be described as the effect on the probability of choosing a profile when an attribute changes values for that profile. So one might say:”Changing the age of the candidate from young to old increases the probability of choosing the candidate profile by <span class="math inline">\(X\)</span> percentage points” (21) (on average against an opponent randomly drawn from the attributes’ randomization distribution).</li>
<li>The AMCE incoporates both preference directionality and preference intensity in the estimates and averages both over respondents and the distribution of attribute combinations. Even if most people prefer a female to male immigrant, it is possible that in a multi-attribute setting, that immigrant gender has little effect due to other attributes taking priority. Therefore, the AMCE will not necessarily correspond to the fraction of voters preferring an attribute <span class="math inline">\(A = a\)</span> over <span class="math inline">\(A = -a\)</span>. Alternatively, if a small number of respondents greatly prefer female to male immigrants, they may drive up the AMCE.</li>
</ul>
</section>
<section id="conjoint-application-in-r" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="conjoint-application-in-r"><span class="header-section-number">11.4</span> Conjoint Application in R</h2>
<p>Let’s look at a more elaborate example from Hainmueller and Hopkins using replication data they provide.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>conj <span class="ot">&lt;-</span> <span class="fu">read.dta</span>(<span class="st">"conjoint.dta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can familiarize ourselves with the data structure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(conj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  CaseID contest_no          FeatEd             FeatJob
1      4          1     high school               Nurse
2      4          1       no formal Child care provider
3      4          2 graduate degree            Gardener
4      4          2       4th grade Construction worker
5      4          3     high school               Nurse
6      4          3  college degree Child care provider
                  FeatLang Chosen_Immigrant
1 tried English but unable              Yes
2         used interpreter               No
3           fluent English               No
4           fluent English              Yes
5           broken English              Yes
6           fluent English               No</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## How many observations?</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(conj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13960</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## How many unique participants?</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(conj<span class="sc">$</span>CaseID)) <span class="co"># 1396 </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## How many contests? (tasks)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>contest_no) <span class="co"># 5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3    4    5 
2792 2792 2792 2792 2792 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Education features</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>FeatEd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
       no formal        4th grade        8th grade      high school 
            1964             2018             1998             1994 
two-year college   college degree  graduate degree 
            2005             1963             2018 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Job features</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>FeatJob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
            Janitor              Waiter Child care provider            Gardener 
               1633                1722                1756                1652 
  Financial analyst Construction worker             Teacher Computer programmer 
                487                1658                1689                 542 
              Nurse  Research scientist              Doctor 
               1731                 540                 550 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Lang features</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>FeatLang)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
          fluent English           broken English tried English but unable 
                    3576                     3440                     3501 
        used interpreter 
                    3443 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Outcome: Choice Task </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>Chosen_Immigrant)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  No  Yes 
6980 6980 </code></pre>
</div>
</div>
<p>Let’s look at the AMCE for language.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Make outcome numeric</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>conj<span class="sc">$</span>Chosen_Immigrant <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(conj<span class="sc">$</span>Chosen_Immigrant <span class="sc">==</span> <span class="st">"Yes"</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>fit.lang <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Chosen_Immigrant <span class="sc">~</span> FeatLang, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> conj, <span class="at">se_type=</span><span class="st">"stata"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">clusters=</span>CaseID)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit.lang)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm_robust(formula = Chosen_Immigrant ~ FeatLang, data = conj, 
    clusters = CaseID, se_type = "stata")

Standard error type:  stata 

Coefficients:
                                 Estimate Std. Error t value  Pr(&gt;|t|) CI Lower
(Intercept)                       0.58753   0.007306  80.414 0.000e+00  0.57320
FeatLangbroken English           -0.06137   0.012036  -5.099 3.890e-07 -0.08497
FeatLangtried English but unable -0.12823   0.012043 -10.648 1.654e-25 -0.15186
FeatLangused interpreter         -0.16319   0.012205 -13.371 1.874e-38 -0.18713
                                 CI Upper   DF
(Intercept)                       0.60186 1395
FeatLangbroken English           -0.03776 1395
FeatLangtried English but unable -0.10461 1395
FeatLangused interpreter         -0.13925 1395

Multiple R-squared:  0.01583 ,  Adjusted R-squared:  0.01562 
F-statistic:  70.4 on 3 and 1395 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>How should we interpret these results? Note that the left-out category is “fluent English.”</p>
<section id="a-wrinkle--restricted-combinations" class="level3" data-number="11.4.1">
<h3 data-number="11.4.1" class="anchored" data-anchor-id="a-wrinkle--restricted-combinations"><span class="header-section-number">11.4.1</span> A wrinkle- restricted combinations</h3>
<p>Sometimes in conjoints we restrict which attributes can appear with other features to avoid nonsensical combinations. For example, education and occupation were restricted in this application. A profile assigned as a computer programmer had to have at least a two-year college degree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(conj<span class="sc">$</span>FeatJob,conj<span class="sc">$</span>FeatEd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     
                      no formal 4th grade 8th grade high school
  Janitor                   290       270       299         240
  Waiter                    275       282       301         283
  Child care provider       288       324       286         315
  Gardener                  257       275       284         284
  Financial analyst           0         0         0           0
  Construction worker       281       283       250         289
  Teacher                   275       288       282         287
  Computer programmer         0         0         0           0
  Nurse                     298       296       296         296
  Research scientist          0         0         0           0
  Doctor                      0         0         0           0
                     
                      two-year college college degree graduate degree
  Janitor                          182            190             162
  Waiter                           171            202             208
  Child care provider              200            172             171
  Gardener                         172            189             191
  Financial analyst                171            154             162
  Construction worker              181            183             191
  Teacher                          201            168             188
  Computer programmer              169            196             177
  Nurse                            197            178             170
  Research scientist               176            169             195
  Doctor                           185            162             203</code></pre>
</div>
</div>
<p>If you incorporate this into your design, you must also incorporate this into the analysis. We can do so by interacting the restricted attributes. We would then need to calculate the average effect of college vs.&nbsp;no formal education among just those job strata that were available for both. `</p>
</section>
<section id="visualizing-the-amce-with-a-package" class="level3" data-number="11.4.2">
<h3 data-number="11.4.2" class="anchored" data-anchor-id="visualizing-the-amce-with-a-package"><span class="header-section-number">11.4.2</span> Visualizing the AMCE with a package</h3>
<p>Some R packages have also incorporated the ability to estimate AMCEs and account for restricted randomizations relatively easily when estimating the AMCE. You can see Leeper’s package <code>cregg</code> <a href="https://cran.r-project.org/web/packages/cregg/vignettes/Introduction.html">here</a> for an example.</p>
<p>Below is an example without restrictions. The <code>cregg</code>package can be nice because it has a plotting tool built into the function. However, you should be careful to understand what it is plotting, and you may want to create your own plots so that you can customize which attributes are plotted and how they appear.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cregg)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>fit.cregg <span class="ot">&lt;-</span> <span class="fu">amce</span>(Chosen_Immigrant <span class="sc">~</span> FeatLang,<span class="at">data=</span> conj, <span class="at">id=</span><span class="sc">~</span>CaseID)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>fit.cregg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           outcome statistic  feature                    level    estimate
1 Chosen_Immigrant      amce FeatLang           fluent English  0.00000000
2 Chosen_Immigrant      amce FeatLang           broken English -0.06136517
3 Chosen_Immigrant      amce FeatLang tried English but unable -0.12823062
4 Chosen_Immigrant      amce FeatLang         used interpreter -0.16318873
   std.error          z            p       lower       upper
1         NA         NA           NA          NA          NA
2 0.01203423  -5.099221 3.410542e-07 -0.08495182 -0.03777853
3 0.01204176 -10.648827 1.765759e-26 -0.15183204 -0.10462920
4 0.01220370 -13.372069 8.805749e-41 -0.18710754 -0.13926991</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit.cregg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="11-conjoints_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="subgroup-analysis" class="level3" data-number="11.4.3">
<h3 data-number="11.4.3" class="anchored" data-anchor-id="subgroup-analysis"><span class="header-section-number">11.4.3</span> Subgroup analysis</h3>
<p>It is perfectly possible to see how the AMCEs differ across different respondent characteristics or combinations of profile characteristics.</p>
<p>When evaluating the difference in AMCEs for different respondent subgroups, <a href="https://www.cambridge.org/core/journals/political-analysis/article/abs/measuring-subgroup-preferences-in-conjoint-experiments/4F2C21AC02753F1FFF2F5EA0F943C1B2">Leeper et al.&nbsp;2020</a> recommend displaying the marginal means from each group (e.g., the probability the immigrant profile was chosen for Democratic vs.&nbsp;Republican respondents) instead of the AMCEs. This is because displaying the AMCEs may obscure very big differences in the preferences of the respondent subgroups among the reference category. The <code>cregg</code> package also talks about this <a href="https://cran.r-project.org/web/packages/cregg/vignettes/Introduction.html">here</a> with tips for visualization.</p>
<p>For example, perhaps Republicans are very opposed to immigrants with no formal education, while Democrats are very supportive. All of the AMCEs within each group are calculated relative to that baseline preference. Even if the AMCEs comparing “college degree” to “no formal education” are similar across partisan subgroups, this would not necessarily mean their overall preferences are similar.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./10-Mediation.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Mediation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>